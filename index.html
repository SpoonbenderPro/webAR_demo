<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>WebAR ‚Äî Stick-to-Camera + CTA (Fixed)</title>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>

  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #container{position:fixed;inset:0}
    #container video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
    #container canvas{position:fixed;inset:0;z-index:1}
    #hint{position:fixed;left:0;right:0;top:10px;text-align:center;color:#fff;opacity:.9;z-index:3}
    #ui{position:fixed;left:12px;right:12px;bottom:12px;z-index:4;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    button,a.button{padding:10px 14px;border:0;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;background:#4f46e5;color:#fff;text-decoration:none}
    button.secondary{background:#374151}
    /* Note: the video element must NOT be display:none ‚Äî some browsers will not advance its frames if fully removed from layout. Keep it offscreen/hidden instead. */
    #hiddenVideo{position:absolute;left:-9999px;top:0;width:1px;height:1px;opacity:0;pointer-events:none}
    #nudge{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;z-index:5;color:#fff;background:#000a;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);display:none}
  </style>
</head>
<body>
  <div id="hint">Point your camera at the target image</div>
  <div id="container"></div>

  <!-- keep video in DOM but offscreen (not display:none) so the browser can advance frames that we use as a texture -->
  <video id="hiddenVideo" src="./promo.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>

  <div id="ui">
    <button id="startBtn">Start AR</button>
    <button id="muteBtn" class="secondary">Unmute</button>
    <button id="restartBtn" class="secondary">Restart</button>
    <a id="ctaBtn" class="button" href="#" target="_blank" rel="noopener">Visit Site</a>
  </div>

  <div id="nudge">üîä Tap ‚ÄúUnmute‚Äù to enable audio</div>

  <script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-image-three';

    const CTA_URL = 'https://example.com';
    document.getElementById('ctaBtn').href = CTA_URL;

    const container = document.getElementById('container');
    const startBtn  = document.getElementById('startBtn');
    const restartBtn= document.getElementById('restartBtn');
    const muteBtn   = document.getElementById('muteBtn');
    const videoEl   = document.getElementById('hiddenVideo');
    const hint      = document.getElementById('hint');
    const nudge     = document.getElementById('nudge');

    // MindAR with smoothing options
    const mindar = new MindARThree({
      container,
      imageTargetSrc: './targets.mind',
      uiLoading:'no', uiScanning:'no', uiError:'no',
      warmupTolerance: 2,
      missTolerance: 8,
      // smoothing options (help reduce jitter)
      filterMinCF: 0.0001,
      filterBeta: 0.01,
      smoothFactor: 0.8
    });
    const { renderer, scene, camera } = mindar;
    renderer.setClearColor(0x000000, 0);
    renderer.domElement.style.touchAction = 'none';
    scene.add(new THREE.AmbientLight(0xffffff, 1));

    // üé• Video texture + plane (16:9). Start invisible so it doesn't show before tracking
    const videoTex = new THREE.VideoTexture(videoEl);
    videoTex.encoding = THREE.sRGBEncoding;
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(16/9, 1),
      new THREE.MeshBasicMaterial({ map: videoTex, side: THREE.DoubleSide, toneMapped:false, transparent:false })
    );
    plane.visible = false; // hide until first track

    // Scale plane to match marker size
    const TARGET_W = 1.0;
    const TARGET_H = 0.56;
    const VID_W = 16/9, VID_H = 1.0;
    plane.scale.set(TARGET_W / VID_W, TARGET_H / VID_H, 1);

    // Anchor and attach plane to it initially
    const anchor = mindar.addAnchor(0);
    anchor.group.add(plane);

    // When marker is lost we will position the plane in front of the camera (stick-to-camera)
    const placeInFrontOfCamera = () => {
      // we'll re-parent to camera to make it appear fixed in view
      if (plane.parent !== camera) camera.add(plane);
      plane.position.set(0, 0, -1.0);
      plane.rotation.set(0, 0, 0);
      plane.visible = true;
    };
    const placeOnAnchor = () => {
      if (plane.parent !== anchor.group) anchor.group.add(plane);
      plane.position.set(0, 0, 0);
      plane.rotation.set(0, 0, 0);
      plane.visible = true;
    };

    // Debug helpers
    const log = (...s) => { console.log('[webar]', ...s); };

    anchor.onTargetFound = () => {
  console.log("[webar] onTargetFound");

  hint.textContent = 'Tracking ‚úì';

  if (plane.parent !== anchor.group) {
    anchor.group.add(plane);
  }
  plane.position.set(0, 0, 0);
  plane.rotation.set(0, 0, 0);
  plane.visible = true;

  if (videoEl.paused) {
    videoEl.play().catch(() => { showNudge(); });
  }
};


    anchor.onTargetLost = () => {
  console.log("[webar] onTargetLost");

  hint.textContent = 'Move back to the target‚Ä¶';

  // üëá reparent plane to camera
  if (plane.parent !== camera) {
    camera.add(plane);
  }

  // üëá put it in front of camera at a visible distance
  plane.position.set(0, 0, -1.5);   // 1.5 units in front
  plane.rotation.set(0, 0, 0);
  plane.visible = true;

  // üëá ensure playback continues
  if (videoEl.paused) {
    videoEl.play().catch(() => { showNudge(); });
  }
};


    // UI
    const setMuteUI = () => { muteBtn.textContent = videoEl.muted ? 'Unmute' : 'Mute'; };
    const showNudge = () => { nudge.style.display='block'; setTimeout(()=> nudge.style.display='none', 2000); };
    setMuteUI();

    muteBtn.addEventListener('click', async () => {
      // toggling mute is a user gesture so unmute will be allowed
      videoEl.muted = !videoEl.muted; setMuteUI();
      try { await videoEl.play(); } catch (e) { console.warn('play after unmute failed', e); showNudge(); }
    });

    restartBtn.addEventListener('click', async () => {
      try { await mindar.stop(); } catch (e) { log('stop failed', e); }
      await mindar.start();
    });

    // START: when user taps Start AR we start MindAR and also perform a muted play to acquire playback permission.
    // We keep the video playing in the background (muted). The plane remains hidden until the marker is found.
    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true; startBtn.textContent = 'Starting‚Ä¶';

      // Acquire permission by doing a muted play on user gesture
      try {
        videoEl.muted = true;
        await videoEl.play();
        log('muted play acquired');
      } catch (err) {
        console.warn('muted play rejected', err);
        // still try to continue ‚Äî onTargetFound will attempt to play again
      }

      try {
        await mindar.start();

        // animation loop: always update the video texture if it has new frames
        renderer.setAnimationLoop(()=>{
          if (videoEl.readyState >= videoEl.HAVE_CURRENT_DATA) {
            videoTex.needsUpdate = true;
          }
          renderer.render(scene, camera);
        });

        startBtn.textContent = 'Running‚Ä¶';
      } catch (e) {
        console.error(e);
        startBtn.disabled = false; startBtn.textContent = 'Start AR (Retry)';
      }
    });

    // keep renderer sized correctly
    const ro = new ResizeObserver(() => {
      renderer.setSize(container.clientWidth, container.clientHeight, false);
    });
    ro.observe(container);

    // Small runtime debug helper you can paste in console
    window._webarDebug = () => ({
      paused: videoEl.paused,
      readyState: videoEl.readyState,
      muted: videoEl.muted,
      parent: plane.parent && plane.parent.type,
    });

  </script>
</body>
</html>
